import fetch from 'node-fetch'
import { fileTypeFromBuffer } from 'file-type'
import { FormData, Blob } from 'formdata-node'
import crypto from 'crypto'
import axios from 'axios'

let handler = async (m, { conn }) => {
    let q = m.quoted ? m.quoted : m
    let mime = (q.msg || q).mimetype || ''
    
    if (!mime) return m.reply('✰ Responde a un video, imagen o gif. ꕤ')

    m.reply('✰ Generando enlace... ꕤ')

    try {
        let buffer = await q.download()
        
        // Intento 1: Catbox
        let link = await uploadCatbox(buffer)
        
        // Intento 2: FreeImage (si falla Catbox)
        if (!link || !link.startsWith('http')) {
            link = await uploadFreeImage(buffer, mime)
        }

        if (!link) throw new Error('Ambos servidores fallaron')

        m.reply(`❀ *Link Generado* ✰\n\nꕤ *URL:* ${link}`)

    } catch (e) {
        console.error(e)
        m.reply('✰ Error al generar el link en ambos servidores. ꕤ')
    }
}

async function uploadCatbox(buffer) {
    try {
        const { ext } = await fileTypeFromBuffer(buffer) || { ext: 'bin' }
        const formData = new FormData()
        const name = crypto.randomBytes(4).toString('hex')
        const blob = new Blob([buffer], { type: `video/${ext}` })
        
        formData.append('reqtype', 'fileupload')
        formData.append('fileToUpload', blob, `${name}.${ext}`)
        
        const res = await fetch('https://catbox.moe/user/api.php', {
            method: 'POST',
            body: formData
        })
        return (await res.text()).trim()
    } catch {
        return null
    }
}

async function uploadFreeImage(buffer, mime) {
    try {
        const form = new FormData()
        form.append('source', buffer.toString('base64'))
        const res = await axios.post('https://freeimage.host/api/1/upload', form, {
            params: { key: '6d207e02198a847aa98d0a2a901485a5' }
        })
        return res.data.image.url
    } catch {
        return null
    }
}

handler.help = ['tourl']
handler.tags = ['tools']
handler.command = ['tourl', 'url', 'link']

export default handler