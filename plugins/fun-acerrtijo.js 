// acertijosBot.js
const { delay } = require('@whiskeysockets/baileys');

class AcertijosManager {
    constructor() {
        this.acertijos = [
            {
                id: 1,
                pregunta: "Blanco por dentro, verde por fuera. Si quieres que te lo diga, espera.",
                respuesta: "pera",
                pistas: ["Es una fruta", "Tiene forma de campana", "Comienza con P"],
                categoria: "frutas"
            },
            {
                id: 2,
                pregunta: "Tiene dientes y no come, tiene cabeza y no es hombre.",
                respuesta: "ajo",
                pistas: ["Se usa en la cocina", "Tiene un olor fuerte", "Es un condimento"],
                categoria: "objetos"
            },
            {
                id: 3,
                pregunta: "Oro parece, plata no es. El que no lo adivine, bien tonto es.",
                respuesta: "plÃ¡tano",
                pistas: ["Es una fruta", "Tiene forma curva", "Es amarillo"],
                categoria: "frutas"
            },
            {
                id: 4,
                pregunta: "Largo como un brazo, duro como piedra, lo abres y no lo comes.",
                respuesta: "hueso",
                pistas: ["Los perros lo muerden", "EstÃ¡ dentro del cuerpo", "Da estructura"],
                categoria: "anatomia"
            },
            {
                id: 5,
                pregunta: "Sin alas vuela, sin ojos llora, sin boca canta.",
                respuesta: "viento",
                pistas: ["No se puede ver", "Mueve las hojas", "Hace frÃ­o"],
                categoria: "naturaleza"
            }
        ];

        this.acertijosActivos = new Map(); // { jid: {acertijo, intentos, timestamp} }
        this.estadisticas = new Map(); // { jid: {acertados: 0, fallados: 0} }
    }

    // Obtener un acertijo aleatorio
    obtenerAcertijoAleatorio() {
        const randomIndex = Math.floor(Math.random() * this.acertijos.length);
        return this.acertijos[randomIndex];
    }

    // Obtener acertijo por categorÃ­a
    obtenerAcertijoPorCategoria(categoria) {
        const filtrados = this.acertijos.filter(a => a.categoria === categoria);
        if (filtrados.length === 0) return this.obtenerAcertijoAleatorio();
        return filtrados[Math.floor(Math.random() * filtrados.length)];
    }

    // Iniciar un nuevo acertijo para un usuario
    iniciarAcertijo(jid, categoria = null) {
        const acertijo = categoria 
            ? this.obtenerAcertijoPorCategoria(categoria) 
            : this.obtenerAcertijoAleatorio();
        
        this.acertijosActivos.set(jid, {
            acertijo: acertijo,
            intentos: 0,
            timestamp: Date.now(),
            pistaUsada: false
        });

        return acertijo;
    }

    // Verificar respuesta
    verificarRespuesta(jid, respuestaUsuario) {
        const activo = this.acertijosActivos.get(jid);
        if (!activo) {
            return { 
                correcto: false, 
                mensaje: "No tienes ningÃºn acertijo activo. Usa !acertijo para comenzar uno." 
            };
        }

        activo.intentos++;
        const respuestaCorrecta = activo.acertijo.respuesta.toLowerCase();
        const respuestaUsuarioLimpia = respuestaUsuario.toLowerCase().trim();

        if (respuestaUsuarioLimpia === respuestaCorrecta) {
            // Actualizar estadÃ­sticas
            this.actualizarEstadisticas(jid, true);
            
            // Limpiar acertijo activo
            this.acertijosActivos.delete(jid);
            
            return {
                correcto: true,
                mensaje: `Â¡Correcto! ðŸŽ‰ La respuesta era: *${respuestaCorrecta}*\nIntentos: ${activo.intentos}`,
                acertijo: activo.acertijo
            };
        } else {
            return {
                correcto: false,
                mensaje: `Respuesta incorrecta âŒ. Intenta de nuevo.\nIntentos: ${activo.intentos}`,
                intentos: activo.intentos
            };
        }
    }

    // Obtener una pista
    obtenerPista(jid) {
        const activo = this.acertijosActivos.get(jid);
        if (!activo) {
            return "No tienes ningÃºn acertijo activo.";
        }

        if (activo.pistaUsada) {
            return "Ya usaste tu pista para este acertijo.";
        }

        activo.pistaUsada = true;
        const pistas = activo.acertijo.pistas;
        const pistaAleatoria = pistas[Math.floor(Math.random() * pistas.length)];
        
        return `ðŸ’¡ *Pista*: ${pistaAleatoria}`;
    }

    // Obtener categorÃ­as disponibles
    obtenerCategorias() {
        const categorias = [...new Set(this.acertijos.map(a => a.categoria))];
        return categorias;
    }

    // Actualizar estadÃ­sticas
    actualizarEstadisticas(jid, acertado) {
        if (!this.estadisticas.has(jid)) {
            this.estadisticas.set(jid, { acertados: 0, fallados: 0 });
        }

        const stats = this.estadisticas.get(jid);
        if (acertado) {
            stats.acertados++;
        } else {
            stats.fallados++;
        }
    }

    // Obtener estadÃ­sticas
    obtenerEstadisticas(jid) {
        const stats = this.estadisticas.get(jid) || { acertados: 0, fallados: 0 };
        return stats;
    }

    // Renunciar al acertijo
    renunciarAcertijo(jid) {
        const activo = this.acertijosActivos.get(jid);
        if (!activo) {
            return "No tienes ningÃºn acertijo activo.";
        }

        this.acertijosActivos.delete(jid);
        this.actualizarEstadisticas(jid, false);
        
        return `ðŸ˜” Te has rendido. La respuesta era: *${activo.acertijo.respuesta}*`;
    }

    // Limpiar acertijos viejos (mÃ¡s de 10 minutos)
    limpiarAcertijosViejos() {
        const ahora = Date.now();
        const diezMinutos = 10 * 60 * 1000;

        for (const [jid, activo] of this.acertijosActivos.entries()) {
            if (ahora - activo.timestamp > diezMinutos) {
                this.acertijosActivos.delete(jid);
            }
        }
    }
}

// Handler para integrar con Baileys
class AcertijosHandler {
    constructor(sock) {
        this.sock = sock;
        this.acertijosManager = new AcertijosManager();
        this.comandos = {
            'acertijo': this.handleAcertijo.bind(this),
            'adivina': this.handleAdivinar.bind(this),
            'pista': this.handlePista.bind(this),
            'rendirse': this.handleRendirse.bind(this),
            'categorias': this.handleCategorias.bind(this),
            'misestadisticas': this.handleEstadisticas.bind(this)
        };

        // Limpiar acertijos viejos cada 5 minutos
        setInterval(() => {
            this.acertijosManager.limpiarAcertijosViejos();
        }, 5 * 60 * 1000);
    }

    async handleMessage(message) {
        const { body, from, sender } = message;
        if (!body) return;

        const comando = body.toLowerCase().split(' ')[0];
        
        if (this.comandos[comando]) {
            await this.comandos[comando](message);
        } else if (this.acertijosManager.acertijosActivos.has(from)) {
            // Si hay un acertijo activo, verificar si es una respuesta
            await this.handleAdivinar(message);
        }
    }

    async handleAcertijo(message) {
        const { from, body } = message;
        const partes = body.split(' ');
        let categoria = null;

        if (partes.length > 1) {
            categoria = partes[1];
        }

        const acertijo = this.acertijosManager.iniciarAcertijo(from, categoria);
        
        let mensaje = `ðŸŽ¯ *Acertijo #${acertijo.id}*\n\n`;
        mensaje += `ðŸ“ ${acertijo.pregunta}\n\n`;
        mensaje += `CategorÃ­a: ${acertijo.categoria}\n`;
        mensaje += `Tienes 10 minutos para responder.\n`;
        mensaje += `Usa: *adivina [respuesta]* para responder\n`;
        mensaje += `      *pista* para una pista\n`;
        mensaje += `      *rendirse* para rendirte`;

        await this.sock.sendMessage(from, { text: mensaje });
    }

    async handleAdivinar(message) {
        const { from, body } = message;
        const respuesta = body.toLowerCase().replace('adivina ', '').trim();

        if (!respuesta) {
            await this.sock.sendMessage(from, { 
                text: "Por favor, usa: *adivina [tu respuesta]*" 
            });
            return;
        }

        const resultado = this.acertijosManager.verificarRespuesta(from, respuesta);
        
        if (resultado.correcto) {
            // Enviar mensaje de felicitaciÃ³n
            await this.sock.sendMessage(from, { 
                text: resultado.mensaje 
            });

            // Enviar sticker de celebraciÃ³n (opcional)
            try {
                await this.sock.sendMessage(from, {
                    sticker: fs.readFileSync('./stickers/felicidades.webp') // Ajusta la ruta
                });
            } catch (e) {
                // Si no hay sticker, enviar emojis
                await this.sock.sendMessage(from, {
                    text: "ðŸŽ‰âœ¨ðŸŽŠ"
                });
            }
        } else {
            await this.sock.sendMessage(from, { 
                text: resultado.mensaje 
            });
        }
    }

    async handlePista(message) {
        const { from } = message;
        const pista = this.acertijosManager.obtenerPista(from);
        await this.sock.sendMessage(from, { text: pista });
    }

    async handleRendirse(message) {
        const { from } = message;
        const respuesta = this.acertijosManager.renunciarAcertijo(from);
        await this.sock.sendMessage(from, { text: respuesta });
    }

    async handleCategorias(message) {
        const { from } = message;
        const categorias = this.acertijosManager.obtenerCategorias();
        let mensaje = "ðŸ“‚ *CategorÃ­as disponibles:*\n\n";
        
        categorias.forEach(cat => {
            const count = this.acertijosManager.acertijos
                .filter(a => a.categoria === cat).length;
            mensaje += `â€¢ ${cat} (${count} acertijos)\n`;
        });

        mensaje += "\nUsa: *acertijo [categorÃ­a]* para un acertijo especÃ­fico";
        
        await this.sock.sendMessage(from, { text: mensaje });
    }

    async handleEstadisticas(message) {
        const { from, sender } = message;
        const stats = this.acertijosManager.obtenerEstadisticas(from);
        
        const total = stats.acertados + stats.fallados;
        const porcentaje = total > 0 ? Math.round((stats.acertados / total) * 100) : 0;

        let mensaje = `ðŸ“Š *Tus EstadÃ­sticas*\n\n`;
        mensaje += `âœ… Acertados: ${stats.acertados}\n`;
        mensaje += `âŒ Fallados: ${stats.fallados}\n`;
        mensaje += `ðŸŽ¯ Porcentaje: ${porcentaje}%\n`;
        mensaje += `ðŸ“ Total intentados: ${total}`;

        await this.sock.sendMessage(from, { text: mensaje });
    }

    // MÃ©todo para agregar mÃ¡s acertijos dinÃ¡micamente
    agregarAcertijo(acertijo) {
        this.acertijosManager.acertijos.push({
            id: this.acertijosManager.acertijos.length + 1,
            ...acertijo
        });
    }

    // Obtener ayuda
    async enviarAyuda(from) {
        const ayuda = `ðŸŽ¯ *COMANDOS DE ACERTIJOS*\n\n` +
            `â€¢ *acertijo* - Nuevo acertijo aleatorio\n` +
            `â€¢ *acertijo [categorÃ­a]* - Acertijo de categorÃ­a especÃ­fica\n` +
            `â€¢ *adivina [respuesta]* - Responder al acertijo\n` +
            `â€¢ *pista* - Obtener una pista\n` +
            `â€¢ *rendirse* - Rendirse y ver la respuesta\n` +
            `â€¢ *categorias* - Ver categorÃ­as disponibles\n` +
            `â€¢ *misestadisticas* - Ver tus estadÃ­sticas`;

        await this.sock.sendMessage(from, { text: ayuda });
    }
}

// FunciÃ³n para integrar con tu bot existente
function setupAcertijosBot(sock) {
    const handler = new AcertijosHandler(sock);
    
    // Escuchar mensajes
    sock.ev.on('messages.upsert', async ({ messages }) => {
        const message = messages[0];
        
        // Ignorar mensajes propios o de grupos si no quieres
        if (message.key.fromMe) return;
        
        await handler.handleMessage({
            ...message,
            body: message.message?.conversation || 
                  message.message?.extendedTextMessage?.text || 
                  message.message?.imageMessage?.caption || ''
        });
    });

    console.log('ðŸ¤– Bot de acertijos activado!');
    return handler;
}

module.exports = { AcertijosManager, AcertijosHandler, setupAcertijosBot };